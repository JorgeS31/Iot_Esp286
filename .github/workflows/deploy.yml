name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: 52.87.251.66
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ec2-user
          if [ -d "DLC_Esp286" ]; then
            cd DLC_Esp286
            git pull origin main
          else
            git clone https://github.com/urpes31/DLC_Esp286.git
            cd DLC_Esp286
          fi
          pip3 install -r requirements.txt
          pkill -f "python.*app.py" || true
          sleep 2
          nohup python3 app.py > flask.log 2>&1 &
          echo " Flask deployed successfully!"
